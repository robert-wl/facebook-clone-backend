package resolver

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.36

import (
	"context"
	"fmt"
	"time"

	"github.com/google/uuid"
	"github.com/yahkerobertkertasnya/TPAWebBack/graph"
	"github.com/yahkerobertkertasnya/TPAWebBack/graph/model"
)

// LikeCount is the resolver for the likeCount field.
func (r *commentResolver) LikeCount(ctx context.Context, obj *model.Comment) (int, error) {
	return int(r.DB.Model(obj).Association("Likes").Count()), nil
}

// ReplyCount is the resolver for the replyCount field.
func (r *commentResolver) ReplyCount(ctx context.Context, obj *model.Comment) (int, error) {
	return int(r.DB.Model(obj).Association("Comments").Count()), nil
}

// Liked is the resolver for the liked field.
func (r *commentResolver) Liked(ctx context.Context, obj *model.Comment) (*bool, error) {
	boolean := false

	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&model.CommentLike{}, "comment_id = ? AND user_id = ?", obj.ID, userID).Error; err == nil {
		boolean = true
	}

	return &boolean, nil
}

// CreatePost is the resolver for the createPost field.
func (r *mutationResolver) CreatePost(ctx context.Context, newPost model.NewPost) (*model.Post, error) {
	var user *model.User
	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&user, "id = ?", userID).Error; err != nil {
		return nil, err
	}

	boolVar := false
	post := &model.Post{
		ID:           uuid.NewString(),
		UserID:       userID,
		User:         user,
		Content:      newPost.Content,
		Privacy:      newPost.Privacy,
		LikeCount:    0,
		CommentCount: 0,
		ShareCount:   0,
		GroupID:      newPost.GroupID,
		Files:        newPost.Files,
		Liked:        &boolVar,
		CreatedAt:    time.Now(),
	}

	if err := r.DB.Save(&post).Error; err != nil {
		return nil, err
	}

	for _, vsb := range newPost.Visibility {
		visibility := &model.PostVisibility{
			PostID: post.ID,
			UserID: *vsb,
		}
		fmt.Println(vsb)

		if err := r.DB.Save(visibility).Error; err != nil {
			return nil, err
		}
	}

	for i, _ := range newPost.Tags {
		fmt.Println(i)
		tagModel := &model.PostTag{
			PostID: post.ID,
			UserID: *newPost.Tags[i],
		}

		if err := r.DB.Create(tagModel).Error; err != nil {
			return nil, err
		}
		fmt.Println(tagModel.UserID)
	}

	if err := r.DB.
		Preload("PostTags.User").
		Preload("Visibility.User").
		First(&post).Error; err != nil {
		return nil, err
	}

	return post, nil
}

// CreateComment is the resolver for the createComment field.
func (r *mutationResolver) CreateComment(ctx context.Context, newComment model.NewComment) (*model.Comment, error) {
	var user *model.User
	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&user, "id = ?", userID).Error; err != nil {
		return nil, err
	}

	boolVar := false
	comment := &model.Comment{
		ID:              uuid.NewString(),
		UserID:          userID,
		User:            user,
		Content:         newComment.Content,
		Liked:           &boolVar,
		LikeCount:       0,
		ReplyCount:      0,
		ParentPostID:    newComment.ParentPost,
		ParentCommentID: newComment.ParentComment,
		CreatedAt:       time.Now(),
	}

	if err := r.DB.Save(&comment).Error; err != nil {
		return nil, err
	}

	return comment, nil
}

// SharePost is the resolver for the sharePost field.
func (r *mutationResolver) SharePost(ctx context.Context, userID string, postID string) (*string, error) {
	var user *model.User

	if err := r.DB.First(&user, "id = ?", userID).Error; err != nil {
		return nil, err
	}

	conv, err := r.CreateConversation(ctx, user.Username)

	if err != nil {
		return nil, err
	}

	_, err = r.SendMessage(ctx, conv.ID, nil, nil, &postID)

	if err != nil {
		return nil, err
	}

	var post *model.Post

	if err := r.DB.First(&post, "id = ?", postID).Error; err != nil {
		return nil, err
	}

	post.ShareCount = post.ShareCount + 1

	if err := r.DB.Save(&post).Error; err != nil {
		return nil, err
	}

	return &conv.ID, nil
}

// LikePost is the resolver for the likePost field.
func (r *mutationResolver) LikePost(ctx context.Context, postID string) (*model.PostLike, error) {
	var postLike *model.PostLike
	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&postLike, "post_id = ? AND user_id = ?", postID, userID).Error; err != nil {
		postLike = &model.PostLike{
			PostID: postID,
			UserID: userID,
		}
		if err := r.DB.Save(&postLike).Error; err != nil {
			return nil, err
		}
	} else {
		if err := r.DB.Delete(&postLike).Error; err != nil {
			return nil, err
		}
	}

	return postLike, nil
}

// Likecomment is the resolver for the likecomment field.
func (r *mutationResolver) Likecomment(ctx context.Context, commentID string) (*model.CommentLike, error) {
	var commentLike *model.CommentLike
	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&commentLike, "post_id = ? AND user_id = ?", commentID, userID).Error; err != nil {
		commentLike = &model.CommentLike{
			CommentID: commentID,
			UserID:    userID,
		}
		if err := r.DB.Save(&commentLike).Error; err != nil {
			return nil, err
		}
	} else {
		if err := r.DB.Delete(&commentLike).Error; err != nil {
			return nil, err
		}
	}

	return commentLike, nil
}

// LikeCount is the resolver for the likeCount field.
func (r *postResolver) LikeCount(ctx context.Context, obj *model.Post) (int, error) {
	return int(r.DB.Model(obj).Association("Likes").Count()), nil
}

// CommentCount is the resolver for the commentCount field.
func (r *postResolver) CommentCount(ctx context.Context, obj *model.Post) (int, error) {
	return int(r.DB.Model(obj).Association("Comments").Count()), nil
}

// Liked is the resolver for the liked field.
func (r *postResolver) Liked(ctx context.Context, obj *model.Post) (*bool, error) {
	boolean := false

	userID := ctx.Value("UserID").(string)

	if err := r.DB.First(&model.PostLike{}, "post_id = ? AND user_id = ?", obj.ID, userID).Error; err == nil {
		boolean = true
	}

	return &boolean, nil
}

// GetPost is the resolver for the getPost field.
func (r *queryResolver) GetPost(ctx context.Context, id string) (*model.Post, error) {
	panic(fmt.Errorf("not implemented: GetPost - getPost"))
}

// GetPosts is the resolver for the getPosts field.
func (r *queryResolver) GetPosts(ctx context.Context, pagination model.Pagination) ([]*model.Post, error) {
	var posts []*model.Post

	userID := ctx.Value("UserID").(string)

	subQueryFriend := r.DB.
		Select("*").
		Where("(sender_id = ? AND receiver_id = posts.user_id) or (sender_id = posts.user_id AND receiver_id = ?)", userID, userID).
		Table("friends")

	subQueryPrivate := r.DB.
		Select("user_id").
		Where("(post_id = posts.id)").
		Table("post_visibilities")

	if err := r.DB.
		Order("created_at desc").
		Preload("User").
		Preload("User").
		Preload("Likes").
		Preload("Comments").
		Preload("Visibility.User").
		Preload("PostTags.User").
		Offset(pagination.Start).
		Limit(pagination.Limit).
		Find(&posts, "privacy = ? OR (privacy = ? AND EXISTS(?)) OR (privacy = ? AND ? IN (?))", "public", "friend", subQueryFriend, "specific", userID, subQueryPrivate).Error; err != nil {
		return nil, err
	}

	//
	return posts, nil
}

// GetGroupPosts is the resolver for the getGroupPosts field.
func (r *queryResolver) GetGroupPosts(ctx context.Context, groupID string, pagination model.Pagination) ([]*model.Post, error) {
	var posts []*model.Post

	if err := r.DB.
		Order("created_at desc").
		Preload("User").
		Preload("Likes").
		Preload("Comments").
		Offset(pagination.Start).
		Limit(pagination.Limit).
		Find(&posts, "group_id = ?", groupID).Error; err != nil {
		return nil, err
	}

	return posts, nil
}

// GetCommentPost is the resolver for the getCommentPost field.
func (r *queryResolver) GetCommentPost(ctx context.Context, postID string) ([]*model.Comment, error) {
	var comments []*model.Comment

	if err := r.DB.
		Preload("User").
		Preload("Likes").
		Preload("Comments").
		Preload("Comments.User").
		Find(&comments, "parent_post_id = ?", postID).Error; err != nil {
		return nil, err
	}

	return comments, nil
}

// Comment returns graph.CommentResolver implementation.
func (r *Resolver) Comment() graph.CommentResolver { return &commentResolver{r} }

// Post returns graph.PostResolver implementation.
func (r *Resolver) Post() graph.PostResolver { return &postResolver{r} }

type commentResolver struct{ *Resolver }
type postResolver struct{ *Resolver }
